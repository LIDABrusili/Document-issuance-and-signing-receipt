<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­¾æ”¶å›æ‰§ç³»ç»Ÿ Â· çŠ¶æ€è¿½è¸ªï¼ˆAä¸Šä¼  / Bæ‰«ç  / AæŸ¥çœ‹çŠ¶æ€ï¼‰</title>
    <!-- å¼•å…¥äºŒç»´ç ç”Ÿæˆåº“ qrcode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: linear-gradient(145deg, #edf2fb 0%, #dde7f5 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5rem;
            color: #0a2540;
            margin-bottom: 10px;
        }
        .header .sub {
            color: #2f4b7c;
            font-size: 1.1rem;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr 1.2fr;
            gap: 24px;
            margin-bottom: 30px;
        }
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
        .card {
            background: white;
            border-radius: 36px;
            padding: 28px;
            box-shadow: 0 20px 40px rgba(0,20,50,0.1);
            border: 1px solid rgba(255,255,255,0.5);
            backdrop-filter: blur(10px);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #eef2f6;
        }
        .avatar {
            width: 56px;
            height: 56px;
            border-radius: 20px;
            background: #0a2540;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 600;
        }
        .avatar.B {
            background: #1e4a6b;
        }
        .avatar.status {
            background: #2d5a27;
        }
        .card-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #0a2540;
        }
        .card-sub {
            color: #64748b;
            font-size: 0.9rem;
            margin-top: 4px;
        }
        /* Aä¸Šä¼ åŒºåŸŸ */
        .upload-area {
            background: #f8fafd;
            border-radius: 24px;
            padding: 24px;
        }
        .file-dropzone {
            border: 2px dashed #b8cae0;
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: 0.15s;
            margin-bottom: 20px;
        }
        .file-dropzone:hover {
            border-color: #0a2540;
            background: #f0f7ff;
        }
        .file-dropzone i {
            font-size: 48px;
            color: #2f5e9c;
            margin-bottom: 12px;
            display: block;
        }
        .selected-file {
            background: #e0ebfc;
            padding: 16px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 16px 0;
            font-weight: 500;
        }
        .btn-primary {
            background: #0a2540;
            color: white;
            border: none;
            width: 100%;
            padding: 18px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.15s;
            box-shadow: 0 8px 16px rgba(10,37,64,0.15);
        }
        .btn-primary:disabled {
            background: #b0c6de;
            cursor: not-allowed;
            box-shadow: none;
        }
        .btn-secondary {
            background: white;
            border: 2px solid #0a2540;
            color: #0a2540;
            padding: 12px 24px;
            border-radius: 40px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.1s;
        }
        .btn-secondary:hover {
            background: #0a2540;
            color: white;
        }
        /* äºŒç»´ç åŒºåŸŸ */
        .qrcode-wrapper {
            background: white;
            border-radius: 24px;
            padding: 24px;
            text-align: center;
            margin: 20px 0;
            border: 2px dashed #9ab3d3;
        }
        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        #qrcode img {
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .link-box {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        .link-box input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid #b8cae0;
            border-radius: 40px;
            font-size: 0.9rem;
            outline: none;
        }
        .link-box button {
            padding: 14px 28px;
            background: white;
            border: 1px solid #0a2540;
            border-radius: 40px;
            font-weight: 600;
            color: #0a2540;
            cursor: pointer;
            white-space: nowrap;
        }
        .link-box button:hover {
            background: #0a2540;
            color: white;
        }
        /* Bç­¾ååŒº */
        .file-info {
            background: #e7f0fd;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .file-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
        }
        .file-details {
            flex: 1;
        }
        .file-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #0a2540;
            margin-bottom: 4px;
        }
        .canvas-container {
            background: #f8fafd;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
        .sign-pad {
            border: 1px solid #b9d1ef;
            border-radius: 16px;
            background: white;
            width: 100%;
            height: 160px;
            cursor: crosshair;
            touch-action: none;
        }
        .sign-actions {
            display: flex;
            gap: 12px;
            margin: 16px 0;
        }
        .sign-actions button {
            flex: 1;
            padding: 12px;
            background: white;
            border: 1px solid #b1c6e0;
            border-radius: 40px;
            font-weight: 500;
            cursor: pointer;
        }
        .sign-actions button:hover {
            background: #dae8ff;
        }
        .receipt-status {
            background: #e3f0ec;
            border-radius: 16px;
            padding: 16px;
            margin-top: 20px;
            border-left: 4px solid #0a5e42;
        }
        /* çŠ¶æ€åˆ—è¡¨ */
        .status-list {
            max-height: 500px;
            overflow-y: auto;
        }
        .status-item {
            background: #f8fafd;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            transition: 0.1s;
        }
        .status-item.signed {
            background: #f0f9f0;
            border-color: #9cd19c;
        }
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .file-tag {
            background: #0a2540;
            color: white;
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-badge.signed {
            background: #d4edda;
            color: #155724;
        }
        .file-meta {
            font-size: 0.9rem;
            color: #4a5568;
            margin-bottom: 12px;
        }
        .signature-preview {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            border: 1px dashed #0a2540;
        }
        .signature-preview img {
            max-height: 50px;
            max-width: 100%;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }
        .warning-banner {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 12px 20px;
            border-radius: 40px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="app-container" id="app">
    <div class="header">
        <h1>âœï¸ ç­¾æ”¶å›æ‰§çŠ¶æ€è¿½è¸ªç³»ç»Ÿ</h1>
        <div class="sub">ç”¨æˆ·Aä¸Šä¼ æ–‡ä»¶ç”ŸæˆäºŒç»´ç  â†’ ç”¨æˆ·Bæ‰«ç ç­¾å â†’ Aå®æ—¶æŸ¥çœ‹ç­¾æ”¶çŠ¶æ€</div>
    </div>

    <!-- 403 æç¤º -->
    <div class="warning-banner" v-if="showWarning">
        âš ï¸ æ£€æµ‹åˆ°å½“å‰ä¸ºæœ¬åœ°æ–‡ä»¶è®¿é—®ã€‚å·²å¯ç”¨Hashæ¨¡å¼ï¼Œå¾®ä¿¡æ‰«ç å¯æ­£å¸¸æ‰“å¼€ã€‚å¦‚éœ€ç”Ÿäº§ä½¿ç”¨ï¼Œè¯·éƒ¨ç½²åˆ°æœåŠ¡å™¨ã€‚
    </div>

    <div class="dashboard">
        <!-- ç”¨æˆ·AåŒºåŸŸï¼šä¸Šä¼ æ–‡ä»¶ & ç”ŸæˆäºŒç»´ç  -->
        <div class="card">
            <div class="card-header">
                <div class="avatar">A</div>
                <div>
                    <div class="card-title">æ–‡ä»¶ç­¾å‘è€… Â· ç”¨æˆ·A</div>
                    <div class="card-sub">ä¸Šä¼ æ–‡ä»¶ï¼Œç”Ÿæˆç­¾æ”¶äºŒç»´ç </div>
                </div>
            </div>
            
            <div class="upload-area">
                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <div class="file-dropzone" @click="triggerFileInput" @dragover.prevent @drop.prevent="handleFileDrop">
                    <i>ğŸ“‚</i>
                    <div style="font-weight:500; margin-bottom:6px;">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                    <div style="font-size:0.9rem; color:#64748b;">æ”¯æŒä»»ä½•æ ¼å¼</div>
                    <input type="file" ref="fileInput" style="display: none;" @change="handleFileSelect">
                </div>

                <!-- å·²é€‰æ–‡ä»¶ -->
                <div class="selected-file" v-if="currentFile">
                    <span style="display: flex; align-items: center; gap:8px;">
                        <span>ğŸ“„</span> {{ currentFile.name }}
                    </span>
                    <button @click="removeCurrentFile" style="background:none; border:none; font-size:20px; cursor:pointer;">âœ•</button>
                </div>

                <!-- ç”ŸæˆäºŒç»´ç æŒ‰é’® -->
                <button class="btn-primary" @click="generateQRCode" :disabled="!currentFile">
                    ğŸ”— ç”Ÿæˆç­¾æ”¶äºŒç»´ç 
                </button>

                <!-- äºŒç»´ç å±•ç¤º -->
                <div class="qrcode-wrapper" v-if="currentQRCode">
                    <div style="font-weight:600; margin-bottom:12px;">ğŸ“· å¾®ä¿¡æ‰«ç ç­¾æ”¶</div>
                    <div id="qrcode"></div>
                    <div class="link-box">
                        <input type="text" :value="currentQRCode" readonly ref="qrLinkInput">
                        <button @click="copyQRLink">å¤åˆ¶</button>
                    </div>
                    <div style="margin-top:12px; color:#4b6382; font-size:0.9rem;">
                        âš¡ ç”¨æˆ·Bæ‰«ç åå³å¯æ‰‹å†™ç­¾å
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·BåŒºåŸŸï¼šæ‰«ç ç­¾å -->
        <div class="card">
            <div class="card-header">
                <div class="avatar B">B</div>
                <div>
                    <div class="card-title">ç­¾æ”¶äºº Â· ç”¨æˆ·B</div>
                    <div class="card-sub">æ‰«æäºŒç»´ç ï¼Œæ‰‹å†™ç­¾åç¡®è®¤</div>
                </div>
            </div>

            <div v-if="!activeReceiptFile">
                <div style="padding: 40px 20px; text-align: center; background: #f8fafd; border-radius: 24px;">
                    <span style="font-size: 48px; display:block; margin-bottom:16px;">ğŸ“±</span>
                    <div style="font-weight:500; margin-bottom:12px;">ç­‰å¾…æ‰«ç ...</div>
                    <div style="color:#64748b; margin-bottom:24px;">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«æå·¦ä¾§äºŒç»´ç </div>
                    
                    <!-- æ¼”ç¤ºç”¨å¿«é€ŸåŠ è½½ -->
                    <button class="btn-secondary" @click="simulateScan" style="width:100%;">
                        ğŸ¯ æ¨¡æ‹Ÿæ‰«ç æ‰“å¼€æ–‡ä»¶ (æ¼”ç¤ºç”¨)
                    </button>
                </div>
            </div>

            <div v-else>
                <!-- æ–‡ä»¶ä¿¡æ¯ -->
                <div class="file-info">
                    <div class="file-icon">ğŸ“„</div>
                    <div class="file-details">
                        <div class="file-name">{{ activeReceiptFile.name }}</div>
                        <div style="color:#64748b; font-size:0.9rem;">
                            ä¸Šä¼ æ—¶é—´: {{ activeReceiptFile.uploadTime }}
                        </div>
                    </div>
                </div>

                <!-- æ‰‹å†™ç­¾ååŒº -->
                <div style="font-weight:600; margin-bottom:12px;">âœï¸ è¯·åœ¨æ­¤æ‰‹å†™ç­¾åç¡®è®¤æ”¶ä»¶</div>
                <div class="canvas-container">
                    <canvas id="signatureCanvas" class="sign-pad" width="400" height="160"></canvas>
                    
                    <div class="sign-actions">
                        <button @click="clearSignature">ğŸ§½ æ¸…ç©º</button>
                        <button @click="saveSignature">ğŸ“ ç¡®è®¤ç­¾å</button>
                    </div>

                    <!-- ç­¾åé¢„è§ˆ -->
                    <div v-if="signatureImage" style="margin-top:16px;">
                        <div style="font-weight:500; margin-bottom:8px;">ç­¾åé¢„è§ˆï¼š</div>
                        <img :src="signatureImage" style="max-height:50px; border:1px solid #b9d1ef; border-radius:8px; padding:8px; background:white;">
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button class="btn-primary" @click="submitReceipt" :disabled="!signatureImage">
                    ğŸ“¬ æäº¤æ‰‹å†™ç­¾æ”¶å›æ‰§
                </button>

                <!-- æäº¤æˆåŠŸæç¤º -->
                <div class="receipt-status" v-if="receiptSubmitted">
                    âœ… å›æ‰§å·²æäº¤ï¼ç”¨æˆ·Aå°†çœ‹åˆ°æ‚¨çš„ç­¾åçŠ¶æ€ã€‚
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·AçŠ¶æ€æŸ¥çœ‹åŒºåŸŸ -->
        <div class="card">
            <div class="card-header">
                <div class="avatar status">ğŸ“Š</div>
                <div>
                    <div class="card-title">ç­¾æ”¶çŠ¶æ€è¿½è¸ª Â· ç”¨æˆ·A</div>
                    <div class="card-sub">å®æ—¶æŸ¥çœ‹å“ªäº›æ–‡ä»¶å·²è¢«ç­¾æ”¶</div>
                </div>
            </div>

            <!-- æ–‡ä»¶çŠ¶æ€åˆ—è¡¨ -->
            <div class="status-list">
                <div v-if="fileRecords.length === 0" class="empty-state">
                    <span style="font-size: 48px; display:block; margin-bottom:16px;">ğŸ“­</span>
                    <div>æš‚æ— æ–‡ä»¶è®°å½•</div>
                    <div style="font-size:0.9rem; margin-top:8px;">å·¦ä¾§ä¸Šä¼ æ–‡ä»¶åï¼Œå°†è‡ªåŠ¨ç”Ÿæˆè®°å½•</div>
                </div>

                <div v-for="(record, index) in fileRecords" :key="index" 
                     class="status-item" :class="{ signed: record.status === 'signed' }">
                    
                    <div class="status-header">
                        <span class="file-tag">æ–‡ä»¶ #{{ index + 1 }}</span>
                        <span class="status-badge" :class="record.status">
                            {{ record.status === 'pending' ? 'â³ å¾…ç­¾æ”¶' : 'âœ… å·²ç­¾æ”¶' }}
                        </span>
                    </div>

                    <div class="file-meta">
                        <div style="font-weight:600; margin-bottom:4px;">{{ record.fileName }}</div>
                        <div>ä¸Šä¼ æ—¶é—´: {{ record.uploadTime }}</div>
                        <div v-if="record.signTime" style="color:#0a5e42;">ç­¾æ”¶æ—¶é—´: {{ record.signTime }}</div>
                    </div>

                    <!-- ç­¾åé¢„è§ˆï¼ˆå·²ç­¾æ”¶ï¼‰ -->
                    <div v-if="record.status === 'signed' && record.signature" class="signature-preview">
                        <div style="font-size:0.9rem; color:#0a2540; margin-bottom:6px;">âœï¸ æ‰‹å†™ç­¾åï¼š</div>
                        <img :src="record.signature" alt="æ‰‹å†™ç­¾å">
                    </div>

                    <!-- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ï¼ˆå·²ç­¾æ”¶ï¼‰ -->
                    <button v-if="record.status === 'signed'" class="btn-secondary" 
                            style="width:100%; margin-top:12px;" @click="viewReceipt(record)">
                        ğŸ“‹ æŸ¥çœ‹å®Œæ•´å›æ‰§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›æ‰§è¯¦æƒ…å¼¹çª— -->
    <div v-if="showReceiptModal" class="modal-overlay" @click="showReceiptModal = false">
        <div class="modal-content" @click.stop>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="margin:0; color:#0a2540;">ğŸ“„ ç­¾æ”¶å›æ‰§è¯¦æƒ…</h2>
                <button @click="showReceiptModal = false" style="background:none; border:none; font-size:24px; cursor:pointer;">âœ•</button>
            </div>
            
            <div style="background: #f8fafd; border-radius: 20px; padding: 24px;">
                <div style="margin-bottom: 20px;">
                    <div style="font-weight:600; color:#0a2540;">æ–‡ä»¶å</div>
                    <div>{{ selectedReceipt?.fileName }}</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight:600; color:#0a2540;">ä¸Šä¼ æ—¶é—´</div>
                    <div>{{ selectedReceipt?.uploadTime }}</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight:600; color:#0a2540;">ç­¾æ”¶æ—¶é—´</div>
                    <div>{{ selectedReceipt?.signTime }}</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-weight:600; color:#0a2540;">æ‰‹å†™ç­¾å</div>
                    <div style="background: white; border-radius: 12px; padding: 20px; margin-top:8px;">
                        <img :src="selectedReceipt?.signature" style="max-height:80px; max-width:100%;">
                    </div>
                </div>
                
                <div style="background: #e3f0ec; border-radius: 16px; padding: 20px; text-align: center;">
                    âœ… è¯¥æ–‡ä»¶å·²è¢«ç”¨æˆ·Bç­¾æ”¶ç¡®è®¤
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script>
(function() {
    new Vue({
        el: '#app',
        data: {
            // å½“å‰ä¸Šä¼ çš„æ–‡ä»¶
            currentFile: null,
            currentQRCode: '',
            
            // æ‰€æœ‰æ–‡ä»¶è®°å½•ï¼ˆç”¨äºçŠ¶æ€è¿½è¸ªï¼‰
            fileRecords: [],
            
            // Bå½“å‰ç­¾æ”¶çš„æ–‡ä»¶
            activeReceiptFile: null,
            signatureImage: null,
            receiptSubmitted: false,
            
            // ç”»æ¿ç›¸å…³
            canvas: null,
            ctx: null,
            drawing: false,
            lastX: 0,
            lastY: 0,
            hasDrawing: false,
            
            // å¼¹çª—
            showReceiptModal: false,
            selectedReceipt: null,
            
            // è­¦å‘Š
            showWarning: true,
            
            // å½“å‰æ–‡ä»¶å¯¹åº”çš„token
            currentToken: ''
        },
        mounted() {
            this.initCanvas();
            
            // æ£€æµ‹URLå‚æ•° (hashæ¨¡å¼)
            this.checkHashParams();
            
            // ç›‘å¬hashå˜åŒ–
            window.addEventListener('hashchange', this.checkHashParams);
        },
        methods: {
            // ========== Aï¼šæ–‡ä»¶ä¸Šä¼  ==========
            triggerFileInput() {
                this.$refs.fileInput.click();
            },
            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.currentFile = file;
                    this.currentQRCode = '';
                    this.clearQRCode();
                }
            },
            handleFileDrop(e) {
                const file = e.dataTransfer.files[0];
                if (file) {
                    this.currentFile = file;
                    this.currentQRCode = '';
                    this.clearQRCode();
                }
            },
            removeCurrentFile() {
                this.currentFile = null;
                this.$refs.fileInput.value = '';
                this.currentQRCode = '';
                this.clearQRCode();
            },
            
            // ========== äºŒç»´ç ç”Ÿæˆ ==========
            generateQRCode() {
                if (!this.currentFile) return;
                
                // ç”Ÿæˆå”¯ä¸€token
                const token = Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
                this.currentToken = token;
                
                // ä½¿ç”¨hashæ¨¡å¼é¿å…403
                const baseUrl = window.location.href.split('#')[0];
                const encodedFileName = encodeURIComponent(this.currentFile.name);
                const hashLink = `${baseUrl}#/receipt/${token}/${encodedFileName}`;
                
                this.currentQRCode = hashLink;
                
                // æ·»åŠ åˆ°æ–‡ä»¶è®°å½•ï¼ˆå¾…ç­¾æ”¶çŠ¶æ€ï¼‰
                this.fileRecords.unshift({
                    fileName: this.currentFile.name,
                    uploadTime: new Date().toLocaleString(),
                    status: 'pending',
                    token: token,
                    signature: null,
                    signTime: null
                });
                
                // ç”ŸæˆäºŒç»´ç 
                this.$nextTick(() => {
                    this.generateQRCodeImage(hashLink);
                });
            },
            
            generateQRCodeImage(link) {
                const qrContainer = document.getElementById('qrcode');
                if (!qrContainer) return;
                
                qrContainer.innerHTML = '';
                
                try {
                    new QRCode(qrContainer, {
                        text: link,
                        width: 200,
                        height: 200,
                        colorDark: '#0a2540',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                } catch (e) {
                    console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥', e);
                }
            },
            
            clearQRCode() {
                const qrContainer = document.getElementById('qrcode');
                if (qrContainer) {
                    qrContainer.innerHTML = '';
                }
            },
            
            copyQRLink() {
                const input = this.$refs.qrLinkInput;
                if (input) {
                    input.select();
                    document.execCommand('copy');
                    alert('é“¾æ¥å·²å¤åˆ¶ï¼');
                }
            },
            
            // ========== Bï¼šæ‰«æç­¾å ==========
            checkHashParams() {
                const hash = window.location.hash;
                if (hash && hash.includes('/receipt/')) {
                    // æ ¼å¼: #/receipt/token/filename
                    const parts = hash.split('/');
                    const token = parts[2];
                    const fileNamePart = parts[3];
                    
                    if (fileNamePart) {
                        try {
                            const fileName = decodeURIComponent(fileNamePart);
                            
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è®°å½•
                            const existingRecord = this.fileRecords.find(r => r.token === token);
                            
                            // å¦‚æœå·²ç­¾æ”¶ï¼Œåˆ™ä¸å…è®¸å†æ¬¡ç­¾æ”¶
                            if (existingRecord && existingRecord.status === 'signed') {
                                alert('è¯¥æ–‡ä»¶å·²è¢«ç­¾æ”¶ï¼Œä¸èƒ½é‡å¤ç­¾å');
                                return;
                            }
                            
                            // è®¾ç½®æ¿€æ´»çš„ç­¾æ”¶æ–‡ä»¶
                            this.activeReceiptFile = {
                                name: fileName,
                                uploadTime: existingRecord ? existingRecord.uploadTime : new Date().toLocaleString(),
                                token: token
                            };
                            
                            this.receiptSubmitted = false;
                            this.signatureImage = null;
                            
                            // é‡ç½®ç”»æ¿
                            this.$nextTick(() => {
                                this.clearSignature();
                                this.initCanvas();
                            });
                        } catch (e) {
                            console.error('è§£ææ–‡ä»¶åå¤±è´¥', e);
                        }
                    }
                }
            },
            
            // æ¨¡æ‹Ÿæ‰«ç ï¼ˆæ¼”ç¤ºç”¨ï¼‰
            simulateScan() {
                // è·å–æœ€æ–°çš„å¾…ç­¾æ”¶æ–‡ä»¶
                const pendingFile = this.fileRecords.find(r => r.status === 'pending');
                if (pendingFile) {
                    this.activeReceiptFile = {
                        name: pendingFile.fileName,
                        uploadTime: pendingFile.uploadTime,
                        token: pendingFile.token
                    };
                    
                    this.receiptSubmitted = false;
                    this.signatureImage = null;
                    
                    this.$nextTick(() => {
                        this.clearSignature();
                        this.initCanvas();
                    });
                } else {
                    alert('æ²¡æœ‰å¾…ç­¾æ”¶çš„æ–‡ä»¶ï¼Œè¯·å…ˆåœ¨å·¦ä¾§ä¸Šä¼ æ–‡ä»¶ç”ŸæˆäºŒç»´ç ');
                }
            },
            
            // ========== ç”»æ¿ç›¸å…³ ==========
            initCanvas() {
                const canvas = document.getElementById('signatureCanvas');
                if (!canvas) return;
                
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.ctx.lineWidth = 2.5;
                this.ctx.strokeStyle = '#0a2540';
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                this.bindDrawingEvents();
                this.drawPlaceholder();
            },
            
            drawPlaceholder() {
                if (!this.hasDrawing && !this.signatureImage && this.ctx) {
                    this.ctx.font = '14px sans-serif';
                    this.ctx.fillStyle = '#b7cbe3';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('åœ¨æ­¤åŒºåŸŸå†…æ‰‹å†™ç­¾å', this.canvas.width/2, this.canvas.height/2);
                }
            },
            
            bindDrawingEvents() {
                if (!this.canvas) return;
                
                this.canvas.addEventListener('mousedown', this.startDrawing);
                this.canvas.addEventListener('mousemove', this.draw);
                this.canvas.addEventListener('mouseup', this.stopDrawing);
                this.canvas.addEventListener('mouseleave', this.stopDrawing);
                
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startDrawing(e);
                });
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.draw(e);
                });
                this.canvas.addEventListener('touchend', this.stopDrawing);
                this.canvas.addEventListener('touchcancel', this.stopDrawing);
            },
            
            startDrawing(e) {
                if (!this.ctx) return;
                this.drawing = true;
                const pos = this.getCoordinates(e);
                if (pos) {
                    this.lastX = pos.x;
                    this.lastY = pos.y;
                }
                
                if (!this.hasDrawing && !this.signatureImage) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.hasDrawing = true;
                }
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
            },
            
            draw(e) {
                if (!this.drawing || !this.ctx) return;
                e.preventDefault();
                
                const pos = this.getCoordinates(e);
                if (!pos) return;
                
                const { x, y } = pos;
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(x, y);
                this.ctx.stroke();
                
                this.lastX = x;
                this.lastY = y;
                this.hasDrawing = true;
            },
            
            stopDrawing() {
                this.drawing = false;
            },
            
            getCoordinates(event) {
                if (!this.canvas) return null;
                
                let clientX, clientY;
                if (event.touches) {
                    if (event.touches.length === 0) return null;
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.canvas.width / rect.width;
                const scaleY = this.canvas.height / rect.height;
                
                let x = (clientX - rect.left) * scaleX;
                let y = (clientY - rect.top) * scaleY;
                
                x = Math.max(0, Math.min(this.canvas.width, x));
                y = Math.max(0, Math.min(this.canvas.height, y));
                
                return { x, y };
            },
            
            clearSignature() {
                if (!this.ctx || !this.canvas) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.signatureImage = null;
                this.hasDrawing = false;
                this.drawPlaceholder();
            },
            
            saveSignature() {
                if (!this.ctx || !this.canvas) return;
                
                // æ£€æµ‹æ˜¯å¦æœ‰ç¬”è¿¹
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const data = imageData.data;
                let hasPixel = false;
                
                for (let i = 3; i < data.length; i += 4) {
                    if (data[i] > 10) {
                        hasPixel = true;
                        break;
                    }
                }
                
                if (!hasPixel) {
                    alert('è¯·å…ˆæ‰‹å†™ç­¾å');
                    return;
                }
                
                this.signatureImage = this.canvas.toDataURL('image/png');
                this.hasDrawing = true;
            },
            
            submitReceipt() {
                if (!this.signatureImage || !this.activeReceiptFile) return;
                
                // æ›´æ–°æ–‡ä»¶è®°å½•çŠ¶æ€
                const record = this.fileRecords.find(r => r.token === this.activeReceiptFile.token);
                if (record) {
                    record.status = 'signed';
                    record.signature = this.signatureImage;
                    record.signTime = new Date().toLocaleString();
                }
                
                this.receiptSubmitted = true;
            },
            
            // ========== Aï¼šæŸ¥çœ‹çŠ¶æ€ ==========
            viewReceipt(record) {
                this.selectedReceipt = record;
                this.showReceiptModal = true;
            }
        },
        watch: {
            activeReceiptFile() {
                this.receiptSubmitted = false;
                this.signatureImage = null;
                this.$nextTick(() => {
                    if (this.canvas) {
                        this.clearSignature();
                    } else {
                        this.initCanvas();
                    }
                });
            }
        }
    });
})();
</script>

<style>
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(5px);
}
.modal-content {
    background: white;
    border-radius: 40px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}
</style>
