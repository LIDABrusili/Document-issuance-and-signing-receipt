<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­¾æ”¶å›æ‰§ Â· å¾®ä¿¡æ‰«ç ç­¾æ”¶ï¼ˆä¿®å¤403ï¼‰</title>
    <!-- å¼•å…¥äºŒç»´ç ç”Ÿæˆåº“ qrcode.js -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        body {
            background: linear-gradient(145deg, #edf2fb 0%, #dde7f5 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .app-container {
            max-width: 1400px;
            width: 100%;
        }
        .warning-banner {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 16px 24px;
            border-radius: 60px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .warning-banner i {
            font-size: 24px;
        }
        .role-switcher {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .role-btn {
            background: white;
            border: none;
            padding: 14px 36px;
            border-radius: 60px;
            font-size: 1.2rem;
            font-weight: 600;
            box-shadow: 0 6px 14px rgba(0,20,50,0.08);
            cursor: pointer;
            transition: 0.2s;
            border: 2px solid transparent;
            color: #1f3a5f;
        }
        .role-btn.active {
            border-color: #0a2540;
            background: #0a2540;
            color: white;
            box-shadow: 0 12px 24px rgba(10,37,64,0.25);
        }
        .main-card {
            background: rgba(255,255,255,0.75);
            backdrop-filter: blur(10px);
            border-radius: 48px;
            padding: 28px;
            box-shadow: 0 30px 50px rgba(0,20,50,0.2);
            border: 1px solid rgba(255,255,255,0.5);
        }
        .split-columns {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 24px;
        }
        .column {
            flex: 1 1 450px;
            background: white;
            border-radius: 36px;
            padding: 32px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.02);
            border: 1px solid rgba(10,37,64,0.08);
            transition: all 0.2s;
        }
        .column-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 28px;
        }
        .avatar {
            width: 56px;
            height: 56px;
            border-radius: 40px;
            background: #0a2540;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 500;
            box-shadow: 0 8px 12px rgba(10,37,64,0.15);
        }
        .column h2 {
            margin: 0;
            font-weight: 600;
            color: #0a2540;
        }
        .column .sub {
            color: #5271a0;
            font-size: 0.95rem;
            margin-top: 4px;
        }
        .upload-panel {
            background: #f5f9ff;
            border-radius: 28px;
            padding: 24px;
            border: 1px solid #cbdaf0;
        }
        .file-dropzone {
            border: 2px dashed #a0bcdb;
            border-radius: 26px;
            padding: 42px 20px;
            text-align: center;
            background: white;
            cursor: pointer;
            transition: 0.15s;
            margin-bottom: 20px;
        }
        .file-dropzone:hover {
            border-color: #0a2540;
            background: #f0f7ff;
        }
        .file-dropzone i {
            font-size: 48px;
            display: block;
            margin-bottom: 12px;
            color: #2f5e9c;
        }
        .selected-file-badge {
            background: #e0ebfc;
            padding: 14px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            margin: 16px 0;
        }
        .generate-link-btn {
            background: #0a2540;
            border: none;
            color: white;
            width: 100%;
            padding: 18px;
            border-radius: 40px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.15s;
            box-shadow: 0 10px 20px rgba(10,37,64,0.15);
        }
        .generate-link-btn:disabled {
            background: #b0c6de;
            box-shadow: none;
            cursor: not-allowed;
        }
        .link-output {
            margin-top: 28px;
            background: #e2ebf6;
            border-radius: 26px;
            padding: 22px;
        }
        .link-label {
            font-weight: 600;
            margin-bottom: 12px;
            color: #0f2b4f;
        }
        .link-box {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .link-box input {
            flex: 3;
            min-width: 200px;
            background: white;
            border: 1px solid #b1c9e8;
            border-radius: 60px;
            padding: 16px 22px;
            font-size: 0.9rem;
            color: #001b3b;
            outline: none;
        }
        .link-box button {
            background: white;
            border: 1px solid #0a2540;
            border-radius: 60px;
            padding: 0 28px;
            font-weight: 600;
            color: #0a2540;
            cursor: pointer;
            transition: 0.1s;
            white-space: nowrap;
        }
        .link-box button:hover {
            background: #0a2540;
            color: white;
        }
        /* äºŒç»´ç åŒºåŸŸ */
        .qrcode-container {
            margin-top: 24px;
            background: white;
            border-radius: 28px;
            padding: 24px;
            text-align: center;
            border: 2px dashed #9ab3d3;
        }
        .qrcode-title {
            font-weight: 600;
            margin-bottom: 16px;
            color: #0f2b4f;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        #qrcode {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }
        #qrcode img {
            margin: 0 auto;
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .scan-hint {
            background: #eef5fe;
            border-radius: 40px;
            padding: 12px;
            margin-top: 16px;
            color: #2d4b75;
            font-size: 0.95rem;
        }
        /* Bè§’è‰²ç­¾ååŒº */
        .sign-panel {
            background: #f9fcff;
            border-radius: 28px;
            padding: 24px;
            border: 1px solid #cbdaf0;
        }
        .file-info-card {
            background: #e7f0fd;
            border-radius: 22px;
            padding: 20px;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            gap: 18px;
            flex-wrap: wrap;
        }
        .file-icon {
            font-size: 32px;
            background: white;
            width: 64px;
            height: 64px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .file-details {
            flex: 1;
        }
        .file-name-big {
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 4px;
            color: #0a2540;
        }
        .file-meta {
            color: #4d688b;
        }
        .canvas-wrapper {
            background: white;
            border-radius: 26px;
            padding: 20px;
            border: 1px solid #cddef5;
            margin: 24px 0 18px;
        }
        .sign-pad {
            border: 1px solid #b9d1ef;
            border-radius: 20px;
            background: white;
            width: 100%;
            height: 170px;
            cursor: crosshair;
            touch-action: none;
        }
        .sign-actions {
            display: flex;
            gap: 14px;
            margin: 18px 0 10px;
            flex-wrap: wrap;
        }
        .sign-actions button {
            background: white;
            border: 1px solid #b1c6e0;
            border-radius: 40px;
            padding: 12px 24px;
            font-weight: 500;
            color: #1f3a5f;
            cursor: pointer;
            flex: 1;
            transition: 0.1s;
        }
        .sign-actions button:hover {
            background: #dae8ff;
            border-color: #2f5e9c;
        }
        .btn-primary {
            background: #0f3d6b;
            color: white;
            border: none;
            border-radius: 40px;
            padding: 18px;
            font-weight: 700;
            font-size: 1.1rem;
            width: 100%;
            cursor: pointer;
            margin-top: 16px;
            transition: 0.15s;
        }
        .btn-primary:disabled {
            background: #b0c4dd;
            cursor: not-allowed;
        }
        .receipt-confirmation {
            background: #e3f0ec;
            border-radius: 26px;
            padding: 24px;
            margin-top: 28px;
            border-left: 6px solid #0a5e42;
        }
        .signature-preview-img {
            max-height: 70px;
            border: 2px dashed #4f7eb3;
            border-radius: 16px;
            padding: 12px;
            background: white;
            margin: 10px 0;
        }
        .footnote {
            text-align: center;
            margin-top: 28px;
            color: #576f8b;
            font-size: 0.9rem;
        }
        .deploy-hint {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 16px 24px;
            border-radius: 60px;
            margin-top: 20px;
            font-size: 0.95rem;
        }
    </style>
</head>
<body>
<div class="app-container" id="app">
    <!-- 403 è­¦å‘Šæç¤º -->
    <div class="warning-banner" v-if="show403Warning">
        <i>âš ï¸</i>
        <span>æ£€æµ‹åˆ°å¯èƒ½é‡åˆ°403é”™è¯¯ã€‚å·²æ”¹ç”¨<strong>Hashæ¨¡å¼</strong>äºŒç»´ç ï¼Œå¾®ä¿¡æ‰«ç å°†æ­£å¸¸æ‰“å¼€ã€‚å¦‚æœä»ç„¶å¤±è´¥ï¼Œè¯·å°†é¡µé¢éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šã€‚</span>
    </div>

    <!-- è§’è‰²åˆ‡æ¢ -->
    <div class="role-switcher">
        <button class="role-btn" :class="{active: activeRole === 'A'}" @click="switchRole('A')" data-role="A">ğŸ“¤ ç”¨æˆ·A Â· ä¸Šä¼ æ–‡ä»¶</button>
        <button class="role-btn" :class="{active: activeRole === 'B'}" @click="switchRole('B')" data-role="B">ğŸ“± ç”¨æˆ·B Â· å¾®ä¿¡æ‰«ç ç­¾æ”¶</button>
    </div>

    <!-- ä¸»å¡ç‰‡ -->
    <div class="main-card">
        <div class="split-columns">
            <!-- å·¦ä¾§ï¼šç”¨æˆ·A (ä¸Šä¼ åŒº + äºŒç»´ç ) -->
            <div class="column" :style="{ opacity: activeRole === 'A' ? 1 : 0.6, background: activeRole === 'A' ? '#fff' : '#f9fafc' }">
                <div class="column-header">
                    <div class="avatar">A</div>
                    <div>
                        <h2>ç”¨æˆ·A Â· æ–‡ä»¶ç­¾å‘è€…</h2>
                        <div class="sub">ä¸Šä¼ æ–‡ä»¶ï¼Œç”ŸæˆäºŒç»´ç ä¾›å¾®ä¿¡æ‰«æ</div>
                    </div>
                </div>
                <div class="upload-panel">
                    <!-- æ–‡ä»¶æ‹–æ‹½åŒº -->
                    <div class="file-dropzone" @click="triggerFileInput" @dragover.prevent @drop.prevent="handleFileDrop">
                        <i>ğŸ“‚</i>
                        <div style="font-weight:500; margin-bottom:6px;">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤</div>
                        <div style="font-size:0.9rem; color:#466289;">ä»»ä½•æ ¼å¼ (PDF, å›¾ç‰‡ç­‰)</div>
                        <input type="file" ref="fileInput" style="display: none;" @change="handleFileSelect">
                    </div>

                    <!-- å·²é€‰æ–‡ä»¶å±•ç¤º -->
                    <div class="selected-file-badge" v-if="uploadedFile">
                        <span style="display: flex; align-items: center; gap:8px;"><span>ğŸ“„</span> {{ uploadedFile.name }}</span>
                        <button @click="removeUploadedFile" style="background:none; border:none; font-size:20px; cursor:pointer;">âœ•</button>
                    </div>

                    <!-- ç”Ÿæˆé“¾æ¥æŒ‰é’® -->
                    <button class="generate-link-btn" @click="generateShareLink" :disabled="!uploadedFile">ğŸ”— ç”Ÿæˆç­¾æ”¶äºŒç»´ç </button>

                    <!-- ç”Ÿæˆçš„é“¾æ¥ + äºŒç»´ç å±•ç¤ºåŒº -->
                    <div class="link-output" v-if="shareLink">
                        <div class="link-label">âœ… ç­¾æ”¶é“¾æ¥ (å¯å¤åˆ¶å‘ç»™B)</div>
                        <div class="link-box">
                            <input type="text" :value="shareLink" readonly ref="shareLinkInput">
                            <button @click="copyShareLink">å¤åˆ¶</button>
                        </div>
                        
                        <!-- äºŒç»´ç  - ä½¿ç”¨hashæ¨¡å¼é¿å…403 -->
                        <div class="qrcode-container">
                            <div class="qrcode-title">
                                <span>ğŸ“· å¾®ä¿¡æ‰«ç ç­¾æ”¶ (Hashæ¨¡å¼)</span>
                            </div>
                            <div id="qrcode"></div>
                            <div class="scan-hint">
                                âš¡ ç”¨æˆ·Bä½¿ç”¨å¾®ä¿¡æ‰«ä¸€æ‰«ï¼Œå³å¯æ‰“å¼€ç­¾æ”¶é¡µé¢<br>
                                <span style="font-size:0.8rem; color:#666;">(ä½¿ç”¨hashè·¯ç”±ï¼Œé¿å…403)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç”¨æˆ·B (ç­¾æ”¶åŒº) æ¨¡æ‹Ÿå¾®ä¿¡æ‰«ç æ‰“å¼€åçš„ç•Œé¢ -->
            <div class="column" :style="{ opacity: activeRole === 'B' ? 1 : 0.6, background: activeRole === 'B' ? '#fff' : '#f9fafc' }">
                <div class="column-header">
                    <div class="avatar">B</div>
                    <div>
                        <h2>ç”¨æˆ·B Â· å¾®ä¿¡ç­¾æ”¶äºº</h2>
                        <div class="sub">æ‰«æäºŒç»´ç ï¼Œæ‰‹å†™ç­¾åç¡®è®¤å›æ‰§</div>
                    </div>
                </div>
                <div class="sign-panel">
                    <!-- å¦‚æœæ²¡æœ‰æ¿€æ´»çš„ç­¾æ”¶æ–‡ä»¶ï¼Œæ˜¾ç¤ºæ‰«ç æç¤º -->
                    <div v-if="!activeReceiptFile">
                        <div style="padding: 30px 20px; text-align: center; background: #f2f7ff; border-radius: 28px; color: #4b6382;">
                            <span style="font-size: 48px; display:block; margin-bottom:16px;">ğŸ“±</span>
                            <div style="font-weight:500; margin-bottom:12px;">è¯·ä½¿ç”¨å¾®ä¿¡æ‰«ç </div>
                            <div style="font-size:0.9rem;">æ‰«æå·¦ä¾§äºŒç»´ç å³å¯åŠ è½½æ–‡ä»¶ç­¾æ”¶</div>
                            
                            <!-- è‡ªåŠ¨æ£€æµ‹URLå‚æ•°å¹¶åŠ è½½ -->
                            <div v-if="urlFileName" class="toast-msg" style="margin-top:20px; background:#0a5e42;">
                                âœ… æ£€æµ‹åˆ°é“¾æ¥å‚æ•°ï¼Œè‡ªåŠ¨åŠ è½½æ–‡ä»¶: {{ urlFileName }}
                            </div>
                            
                            <!-- æ¨¡æ‹Ÿæ‰‹åŠ¨åŠ è½½ï¼ˆæ–¹ä¾¿æ¼”ç¤ºï¼‰ -->
                            <div style="margin-top:24px; padding-top:16px; border-top:1px dashed #baceec;">
                                <div style="font-size:0.9rem; margin-bottom:12px;">ğŸ”§ æ¼”ç¤ºå¿«é€ŸåŠ è½½ï¼š</div>
                                <button @click="simulateScanFromQrcode" style="background:#0a2540; color:white; border:none; border-radius:40px; padding:12px 28px; cursor:pointer; margin-right:8px;">
                                    æ¨¡æ‹Ÿæ‰«ç æ‰“å¼€æ–‡ä»¶
                                </button>
                                <button @click="checkHashParams" style="background:#6c757d; color:white; border:none; border-radius:40px; padding:12px 28px; cursor:pointer;">
                                    æ£€æµ‹URLå‚æ•°
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- æœ‰æ¿€æ´»æ–‡ä»¶ï¼šæ˜¾ç¤ºç­¾æ”¶å›æ‰§ç•Œé¢ -->
                    <div v-else>
                        <div class="file-info-card">
                            <div class="file-icon">ğŸ“„</div>
                            <div class="file-details">
                                <div class="file-name-big">{{ activeReceiptFile.name }}</div>
                                <div class="file-meta">ä¸Šä¼ è€…ï¼šç”¨æˆ·A Â· {{ activeReceiptFile.uploadTime || 'åˆšåˆš' }}</div>
                            </div>
                        </div>

                        <!-- æ‰‹å†™ç­¾ååŒº -->
                        <div style="font-weight:600; margin-bottom:14px;">âœï¸ è¯·åœ¨ä¸‹æ–¹æ‰‹å†™ç­¾åç¡®è®¤æ”¶ä»¶</div>
                        <div class="canvas-wrapper">
                            <canvas id="signatureCanvasB" class="sign-pad" width="400" height="170"></canvas>
                            <div class="sign-actions">
                                <button @click="clearSignatureB">ğŸ§½ æ¸…ç©º</button>
                                <button @click="saveSignatureB">ğŸ“ ç¡®è®¤ç­¾å</button>
                            </div>
                            <!-- ç­¾åé¢„è§ˆ -->
                            <div v-if="signatureB" style="margin-top:12px; display:flex; align-items:center; gap:10px;">
                                <span>âœ… å·²ç­¾å:</span>
                                <img :src="signatureB" style="max-height:45px; border:1px solid #c7daf5; border-radius:10px; background:white; padding:6px;">
                            </div>
                        </div>

                        <!-- æäº¤å›æ‰§æŒ‰é’® -->
                        <button class="btn-primary" @click="submitReceipt" :disabled="!signatureB">ğŸ“¬ æäº¤æ‰‹å†™ç­¾æ”¶å›æ‰§</button>

                        <!-- å›æ‰§å®Œæˆæç¤º -->
                        <div class="receipt-confirmation" v-if="receiptSubmitted">
                            <span style="font-size:22px; margin-right:12px;">âœ…</span> 
                            <strong>å›æ‰§å·²ç­¾æ”¶ï¼</strong> æ‰‹å†™ç­¾åå·²é™„ç€åœ¨æ–‡ä»¶å›æ‰§ä¸Šã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footnote">
            âš¡ å·¥ä½œæµï¼šAä¸Šä¼ æ–‡ä»¶ â†’ ç”ŸæˆäºŒç»´ç  â†’ Bå¾®ä¿¡æ‰«ç  â†’ æ‰‹å†™ç­¾å â†’ æäº¤å›æ‰§
        </div>
        
        <!-- éƒ¨ç½²æç¤º -->
        <div class="deploy-hint" v-if="showDeployHint">
            <strong>ğŸŒ éƒ¨ç½²åˆ°æœåŠ¡å™¨å¯å½»åº•è§£å†³403ï¼š</strong> å°†æœ¬é¡µé¢ä¸Šä¼ åˆ°ä»»ä½•é™æ€æ‰˜ç®¡æœåŠ¡ï¼ˆGitHub Pagesã€Vercelã€Netlifyç­‰ï¼‰ï¼Œå³å¯æ­£å¸¸ä½¿ç”¨ã€‚ç›®å‰ä½¿ç”¨hashæ¨¡å¼å·²å¯ä¸´æ—¶è§£å†³ã€‚
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script>
(function() {
    new Vue({
        el: '#app',
        data: {
            activeRole: 'A',
            // Açš„æ•°æ®
            uploadedFile: null,
            shareLink: '',
            qrCodeGenerated: false,
            // Bçš„æ•°æ®
            activeReceiptFile: null,
            signatureB: null,
            receiptSubmitted: false,
            // canvas ç›¸å…³
            canvasB: null,
            ctxB: null,
            drawingB: false,
            lastXB: 0,
            lastYB: 0,
            hasDrawingB: false,
            // ç”¨äºä¿å­˜å½“å‰äºŒç»´ç å¯¹åº”çš„æ–‡ä»¶token
            currentFileToken: null,
            // ä»URLæ£€æµ‹åˆ°çš„æ–‡ä»¶å
            urlFileName: '',
            // æ§åˆ¶è­¦å‘Šæ˜¾ç¤º
            show403Warning: true,
            showDeployHint: true
        },
        mounted() {
            // åˆå§‹åŒ–Bç”»æ¿
            this.$nextTick(() => {
                this.initCanvasB();
            });
            
            // æ£€æµ‹URLå‚æ•° (hashæ¨¡å¼)
            this.checkHashParams();
            
            // ç›‘å¬hashå˜åŒ–
            window.addEventListener('hashchange', this.checkHashParams);
        },
        methods: {
            // ========== è§’è‰²åˆ‡æ¢è§†è§‰æ•ˆæœ ==========
            switchRole(role) {
                this.activeRole = role;
            },

            // ========== A ä¸Šä¼ æ–‡ä»¶é€»è¾‘ ==========
            triggerFileInput() {
                this.$refs.fileInput.click();
            },
            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file) {
                    this.uploadedFile = file;
                    this.shareLink = '';
                    this.qrCodeGenerated = false;
                    // æ¸…é™¤ä¹‹å‰çš„äºŒç»´ç 
                    this.clearQrCode();
                }
            },
            handleFileDrop(e) {
                const file = e.dataTransfer.files[0];
                if (file) {
                    this.uploadedFile = file;
                    this.shareLink = '';
                    this.qrCodeGenerated = false;
                    this.clearQrCode();
                }
            },
            removeUploadedFile() {
                this.uploadedFile = null;
                this.$refs.fileInput.value = '';
                this.shareLink = '';
                this.qrCodeGenerated = false;
                this.clearQrCode();
            },
            
            // æ¸…é™¤äºŒç»´ç 
            clearQrCode() {
                const qrContainer = document.getElementById('qrcode');
                if (qrContainer) {
                    qrContainer.innerHTML = '';
                }
            },

            generateShareLink() {
                if (!this.uploadedFile) return;
                
                // ç”Ÿæˆå”¯ä¸€token
                const token = Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
                this.currentFileToken = token;
                
                // ä½¿ç”¨hashæ¨¡å¼é¿å…403 (fileåè®®ä¸‹ä¸ä¼šè§¦å‘æœåŠ¡å™¨è¯·æ±‚)
                const baseUrl = window.location.href.split('#')[0]; // å»æ‰å·²æœ‰hash
                // æ„é€ hashæ ¼å¼é“¾æ¥: #/receipt/token/æ–‡ä»¶å
                const encodedFileName = encodeURIComponent(this.uploadedFile.name);
                const hashLink = `${baseUrl}#/receipt/${token}/${encodedFileName}`;
                
                this.shareLink = hashLink;

                // ç”ŸæˆäºŒç»´ç 
                this.$nextTick(() => {
                    this.generateQrCode(hashLink);
                });
                
                // è‡ªåŠ¨åœ¨Bç«¯æ¨¡æ‹Ÿä¸€ä¸‹ï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰
                this.urlFileName = this.uploadedFile.name;
            },

            generateQrCode(link) {
                // æ¸…ç©ºæ—§çš„äºŒç»´ç 
                const qrContainer = document.getElementById('qrcode');
                if (!qrContainer) return;
                
                qrContainer.innerHTML = '';
                
                // ä½¿ç”¨QRCode.jsç”Ÿæˆ
                try {
                    new QRCode(qrContainer, {
                        text: link,
                        width: 200,
                        height: 200,
                        colorDark: '#0a2540',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    this.qrCodeGenerated = true;
                } catch (e) {
                    console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥', e);
                }
            },

            copyShareLink() {
                const input = this.$refs.shareLinkInput;
                if (input) {
                    input.select();
                    document.execCommand('copy');
                    alert('é“¾æ¥å·²å¤åˆ¶ï¼ç”¨æˆ·Bå¯ä»¥ç›´æ¥è®¿é—®ï¼Œæˆ–æ‰«æäºŒç»´ç ');
                }
            },

            // ========== B æ£€æµ‹URLå‚æ•° (hashæ¨¡å¼) ==========
            checkHashParams() {
                const hash = window.location.hash;
                if (hash && hash.includes('/receipt/')) {
                    // æ ¼å¼: #/receipt/token/filename
                    const parts = hash.split('/');
                    // æ‰¾åˆ°filenameéƒ¨åˆ†ï¼ˆæœ€åä¸€éƒ¨åˆ†ï¼‰
                    const fileNamePart = parts[parts.length - 1];
                    if (fileNamePart) {
                        try {
                            const fileName = decodeURIComponent(fileNamePart);
                            this.urlFileName = fileName;
                            
                            // è‡ªåŠ¨åŠ è½½æ–‡ä»¶
                            this.activeReceiptFile = {
                                name: fileName,
                                uploadTime: new Date().toLocaleString()
                            };
                            this.receiptSubmitted = false;
                            this.signatureB = null;
                            
                            // é‡ç½®ç”»æ¿
                            this.$nextTick(() => {
                                this.clearSignatureB();
                                this.initCanvasB();
                            });
                        } catch (e) {
                            console.error('è§£ææ–‡ä»¶åå¤±è´¥', e);
                        }
                    }
                } else {
                    // å°è¯•ä»ä¼ ç»Ÿqueryå‚æ•°è§£æï¼ˆå…¼å®¹ï¼‰
                    const urlParams = new URLSearchParams(window.location.search);
                    const fileParam = urlParams.get('file');
                    if (fileParam) {
                        this.urlFileName = decodeURIComponent(fileParam);
                    }
                }
            },

            // ========== B æ¨¡æ‹Ÿæ‰«ç é€»è¾‘ ==========
            simulateScanFromQrcode() {
                // æ¨¡æ‹Ÿå¾®ä¿¡æ‰«ç åæ‰“å¼€é“¾æ¥
                let fileName = 'æ”¶åˆ°çš„æ–‡ä»¶.pdf';
                let uploadTime = new Date().toLocaleString();
                
                if (this.uploadedFile) {
                    fileName = this.uploadedFile.name;
                } else if (this.urlFileName) {
                    fileName = this.urlFileName;
                } else if (this.shareLink && this.shareLink.includes('/receipt/')) {
                    try {
                        const parts = this.shareLink.split('/');
                        const namePart = parts[parts.length - 1];
                        if (namePart) {
                            fileName = decodeURIComponent(namePart);
                        }
                    } catch (e) {}
                }
                
                // è®¾ç½®æ¿€æ´»çš„å›æ‰§æ–‡ä»¶
                this.activeReceiptFile = {
                    name: fileName,
                    uploadTime: uploadTime
                };
                this.receiptSubmitted = false;
                this.signatureB = null;
                
                // é‡ç½®ç”»æ¿
                this.$nextTick(() => {
                    this.clearSignatureB();
                    this.initCanvasB();
                });
            },

            // ========== B ç­¾åé€»è¾‘ ==========
            initCanvasB() {
                const canvas = document.getElementById('signatureCanvasB');
                if (!canvas) return;
                
                this.canvasB = canvas;
                this.ctxB = canvas.getContext('2d');
                this.ctxB.lineWidth = 2.5;
                this.ctxB.strokeStyle = '#0a2540';
                this.ctxB.lineCap = 'round';
                this.ctxB.lineJoin = 'round';
                this.bindDrawingB();
                this.drawPlaceholderB();
            },

            drawPlaceholderB() {
                if (!this.hasDrawingB && !this.signatureB && this.ctxB) {
                    this.ctxB.font = '14px sans-serif';
                    this.ctxB.fillStyle = '#b7cbe3';
                    this.ctxB.textAlign = 'center';
                    this.ctxB.fillText('åœ¨æ­¤åŒºåŸŸå†…æ‰‹å†™ç­¾å', this.canvasB.width/2, this.canvasB.height/2);
                }
            },

            bindDrawingB() {
                if (!this.canvasB) return;
                const canvas = this.canvasB;
                
                canvas.addEventListener('mousedown', this.startDrawingB);
                canvas.addEventListener('mousemove', this.drawB);
                canvas.addEventListener('mouseup', this.stopDrawingB);
                canvas.addEventListener('mouseleave', this.stopDrawingB);
                
                canvas.addEventListener('touchstart', (e) => { 
                    e.preventDefault(); 
                    this.startDrawingB(e);
                });
                canvas.addEventListener('touchmove', (e) => { 
                    e.preventDefault(); 
                    this.drawB(e);
                });
                canvas.addEventListener('touchend', this.stopDrawingB);
                canvas.addEventListener('touchcancel', this.stopDrawingB);
            },

            startDrawingB(e) {
                if (!this.ctxB) return;
                this.drawingB = true;
                const pos = this.getCoordinatesB(e);
                if (pos) {
                    this.lastXB = pos.x;
                    this.lastYB = pos.y;
                }
                // æ¸…é™¤å ä½ç¬¦
                if (!this.hasDrawingB && !this.signatureB) {
                    this.ctxB.clearRect(0, 0, this.canvasB.width, this.canvasB.height);
                    this.hasDrawingB = true;
                }
                this.ctxB.beginPath();
                this.ctxB.moveTo(this.lastXB, this.lastYB);
            },

            drawB(e) {
                if (!this.drawingB || !this.ctxB) return;
                e.preventDefault();
                const pos = this.getCoordinatesB(e);
                if (!pos) return;
                
                const { x, y } = pos;
                this.ctxB.beginPath();
                this.ctxB.moveTo(this.lastXB, this.lastYB);
                this.ctxB.lineTo(x, y);
                this.ctxB.stroke();
                this.lastXB = x;
                this.lastYB = y;
                this.hasDrawingB = true;
            },

            stopDrawingB() {
                this.drawingB = false;
            },

            getCoordinatesB(event) {
                if (!this.canvasB) return null;
                
                let clientX, clientY;
                if (event.touches) {
                    if (event.touches.length === 0) return null;
                    clientX = event.touches[0].clientX;
                    clientY = event.touches[0].clientY;
                } else {
                    clientX = event.clientX;
                    clientY = event.clientY;
                }
                
                const rect = this.canvasB.getBoundingClientRect();
                const scaleX = this.canvasB.width / rect.width;
                const scaleY = this.canvasB.height / rect.height;
                
                let x = (clientX - rect.left) * scaleX;
                let y = (clientY - rect.top) * scaleY;
                
                x = Math.max(0, Math.min(this.canvasB.width, x));
                y = Math.max(0, Math.min(this.canvasB.height, y));
                
                return { x, y };
            },

            clearSignatureB() {
                if (!this.ctxB || !this.canvasB) return;
                this.ctxB.clearRect(0, 0, this.canvasB.width, this.canvasB.height);
                this.signatureB = null;
                this.hasDrawingB = false;
                this.drawPlaceholderB();
            },

            saveSignatureB() {
                if (!this.ctxB || !this.canvasB) return;
                
                // æ£€æµ‹æ˜¯å¦æœ‰ç¬”è¿¹
                const imageData = this.ctxB.getImageData(0, 0, this.canvasB.width, this.canvasB.height);
                const data = imageData.data;
                let hasPixel = false;
                
                for (let i = 3; i < data.length; i += 4) {
                    if (data[i] > 10) { 
                        hasPixel = true; 
                        break; 
                    }
                }
                
                if (!hasPixel) {
                    alert('è¯·å…ˆæ‰‹å†™ç­¾å');
                    return;
                }
                
                this.signatureB = this.canvasB.toDataURL('image/png');
                this.hasDrawingB = true;
            },

            submitReceipt() {
                if (!this.signatureB) {
                    alert('è¯·å…ˆç¡®è®¤ç­¾å');
                    return;
                }
                
                this.receiptSubmitted = true;
            }
        },
        watch: {
            // å½“é€šè¿‡é“¾æ¥ç”Ÿæˆ activeReceiptFile æ—¶ï¼Œé‡ç½®ç­¾åçŠ¶æ€
            activeReceiptFile() {
                this.receiptSubmitted = false;
                this.signatureB = null;
                this.$nextTick(() => {
                    if (this.canvasB) {
                        this.clearSignatureB();
                    } else {
                        this.initCanvasB();
                    }
                });
            }
        }
    });
})();
</script>
</body>
</html>
